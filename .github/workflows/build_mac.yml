name: Reusable Dive Build on MacOs

on:
  workflow_call:
    inputs:
      build_type:
        required: true
        type: string
      upload_cache:
        required: true
        type: boolean

jobs:
  build_host_mac:
    name: Build Host Mac ${{ inputs.build_type }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Install Qt 5.15 via Homebrew
        run: |
          brew install qt@5
          # Link it so standard commands might find it, or just set env vars below
          echo "Qt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5" >> $GITHUB_ENV
          echo "PATH=$(brew --prefix qt@5)/bin:$PATH" >> $GITHUB_ENV
      - name: Check Qt Version
        run: qmake --version
      - name: (ccache) Install via Homebrew
        run: brew install ccache
      - name: (ccache) Configure for uploading (upload_cache)
        if: ${{ inputs.upload_cache }}
        run: ccache -z
      - name: (ccache) Configure for restoring (!upload_cache)
        if: ${{ !(inputs.upload_cache) }}
        run: |
          ccache -z
          ccache --set-config=read_only=true
      - name: (ccache) Cache (upload_cache)
        if: ${{ inputs.upload_cache }}
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-${{ inputs.build_type }}-ccache-continuous-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.build_type }}-ccache-continuous-
      - name: (ccache) Restore (!upload_cache)
        if: ${{ !(inputs.upload_cache) }}
        uses: actions/cache/restore@v5
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-${{ inputs.build_type }}-ccache-continuous-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-${{ inputs.build_type }}-ccache-continuous-
      - name: Install Dive dependencies
        run: |
          python3 -m pip install --break-system-packages mako
      - name: Generate build files with cmake
        run: |
          time cmake \
            -G "Ninja Multi-Config" \
            -DCMAKE_C_COMPILER_LAUNCHER="cmake;-E;time;ccache" \
            -DCMAKE_CXX_COMPILER_LAUNCHER="cmake;-E;time;ccache" \
            -DCMAKE_C_LINKER_LAUNCHER="cmake;-E;time" \
            -DCMAKE_CXX_LINKER_LAUNCHER="cmake;-E;time" \
            -Bbuild .
      - name: Build Dive host tools with ninja
        run: |
          time ninja -C build -d stats -f build-${{ inputs.build_type }}.ninja
      - name: (ccache) Show stats
        run: ccache -s
      - name: Ninja log
        run: |
          cat build/.ninja_log
      - name: Produce install artifacts
        run: |
          cmake --install build --prefix pkg --config ${{ inputs.build_type }}
      - name: Put files in app bundle
        run: |
          scripts/deploy_mac_bundle_presubmit.sh
      - name: Run tests
        run: |
          ctest --output-on-failure -C ${{ inputs.build_type }} --test-dir build
